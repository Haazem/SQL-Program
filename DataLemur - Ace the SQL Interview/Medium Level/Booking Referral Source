WITH CTE 
AS(
SELECT  user_id , b.booking_id , booking_date , channel
FROM bookings b 
JOIN booking_attribution  a  
ON b.booking_id = a.booking_id 
)
, CTE2 
AS (
SELECT user_id , channel 
FROM CTE c2 
WHERE booking_date = (SELECT MIN(booking_date)
                      FROM CTE c1 
                      WHERE c1.user_id = c2.user_id)),
                      
CTE3
AS(
SELECT channel , COUNT(*) AS cnt 
FROM CTE2 
WHERE channel IS NOT NULL 
GROUP BY channel
ORDER BY cnt DESC 
LIMIT 1)

SELECT  channel ,
        ROUND(CAST(cnt AS DECIMAL) / 
        (SELECT COUNT(user_id) FROM CTE2) * 100.0,0)
        AS first_booking_pct
FROM CTE3 



                  
